<html>
<meta charset="utf-8"/>
<head>
<title>Guitar Friend</title>
<style>
/****************************************************************************/
/* TAB style */

/* Style the tab */
.tab {
  overflow: hidden;
  border: 1px solid rgb(125, 214, 243);
  background-color: lightblue;
}

/* Style the buttons that are used to open the tab content */
.tab button {
  background-color: inherit;
  float: left;
  border: none;
  outline: none;
  cursor: pointer;
  padding: 14px 16px;
  transition: 0.3s;
}

/* Special for the settings TAB */
#tab-settings {
    float: right;
    font-size: 27px;
    padding: 6px 16px 5px;
}

/* Change background color of buttons on hover */
.tab button:hover {
  background-color: rgb(125, 190, 211);
}

/* Create an active/current tab class */
.tab button.active {
  background-color: rgb(55, 138, 165);
}

/* Style the tab content */
.tab-page {
  display: none;
  padding: 6px 12px;
  /*border: 1px solid rgb(125, 214, 243);
  border-top: none;*/
  /*display: block;*/
  /*height: 100%;*/
}
</style>
</head>
<script>

//////////////////////////////////////////////////////////////////////////
// Music stuff

const notes = ["A", "A♮/B♭", "B", "C", "C♮/D♭", "D", "D♮/E♭", "E", "F", "F♮/G♭", "G", "G♮/A♭"];
const tuningStandard = ["E", "B", "G", "D", "A", "E"];
const fretMarkers = [3, 5, 7, 9, 12, 15, 17, 19, 21, 24];

// fret 0 = no open string
function noteAt(fret, string) {
    var firstNote = tuningStandard[string];
    var index = notes.indexOf(firstNote);
    index = (index + fret) % notes.length;
    return notes[index];
}

//////////////////////////////////////////////////////////////////////////
// Misc

window.onload = function() {
    tabSetup();
    updateDisplay();
    window.onresize = updateDisplay;
}

function updateDisplay() {
    drawGuitarNotes();
}

//////////////////////////////////////////////////////////////////////////////
// TAB page general handling

function drawGuitarNotes() {
    var canvas = document.getElementById("guitar-canvas");
    var parentStyle = window.getComputedStyle(canvas.parentElement);
    canvas.width = parseFloat(parentStyle.width);

    var ctx = canvas.getContext("2d");

    // Misc constants
    const STRING_SPACE = 25;
    const STRING_COUNT = 6;
    const FRET_WIDTH = 70;
    const FRET_COUNT = Math.floor(canvas.width / FRET_WIDTH) - 1;
    canvas.height = STRING_SPACE * (STRING_COUNT + 2);

    //////////////////////////////////////////////////////////////////////////
    // Draw strings
    ctx.strokeStyle = "black";
    ctx.lineWidth = 1;

    for (var string = 0; string < STRING_COUNT; string++) {
        ctx.beginPath();
        ctx.moveTo(FRET_WIDTH, STRING_SPACE * (string + 1));
        ctx.lineTo(FRET_WIDTH * (FRET_COUNT + 1), STRING_SPACE * (string + 1));
        ctx.stroke();  
    }

    //////////////////////////////////////////////////////////////////////////
    // Draw fret lines
    for (var fret = 1; fret <= (FRET_COUNT + 1); fret++) {
        ctx.beginPath();
        ctx.moveTo(FRET_WIDTH * fret, STRING_SPACE);
        ctx.lineTo(FRET_WIDTH * fret, STRING_SPACE * STRING_COUNT);
        ctx.stroke();  
    }


    //////////////////////////////////////////////////////////////////////////
    // Draw fret markers
    ctx.fillStyle = "black";
    fretMarkers.forEach(function(fret) {
        if (fret <= FRET_COUNT) {
            ctx.beginPath();
            ctx.arc(fret * FRET_WIDTH + (FRET_WIDTH / 2), 
                    STRING_COUNT * STRING_SPACE + STRING_SPACE, 
                    Math.round(STRING_SPACE * 0.1), 0, 2 * Math.PI);
            ctx.stroke();
            ctx.fill();             
        }
    });

    //////////////////////////////////////////////////////////////////////////
    // Write note text
    for (var string = 0; string < STRING_COUNT; string++) {
        for (var fret = 0; fret < (FRET_COUNT + 1); fret++) {
            var centerX = FRET_WIDTH * fret + FRET_WIDTH / 2;
            var centerY = STRING_SPACE * (string + 1);

            var note = noteAt(fret, string);

            var backgroundColor= "white";
            var textColor = "black";
            switch (note) {
                case "A":
                    backgroundColor = "lightblue"; 
                    break; 
                case "B":
                    backgroundColor = "lightgreen"; 
                    break; 
                case "C":
                    backgroundColor = "lightpink"; 
                    break; 
                case "D":
                    backgroundColor = "lightgray"; 
                    break; 
                case "E":
                    backgroundColor = "lightyellow"; 
                    break; 
                case "F":
                    backgroundColor = "fuchsia"; 
                    break; 
                case "G":
                    backgroundColor = "lightsalmon"; 
                    break; 
            }
            ctx.beginPath();
            ctx.fillStyle = backgroundColor;

            if (note.includes("/")) {
                var rectWidth = Math.round(FRET_WIDTH * 0.8);
                var rectHeight = Math.round(STRING_SPACE * 0.8);
                ctx.rect(centerX - (rectWidth / 2), centerY - (rectHeight / 2), rectWidth, rectHeight);
                ctx.font = Math.round(STRING_SPACE * 0.4) + "px Arial";
            } else {
                ctx.arc(centerX, centerY, Math.round(STRING_SPACE * 0.45), 0, 2 * Math.PI);
                ctx.font = Math.round(STRING_SPACE * 0.5) + "px Arial";
            }
            ctx.stroke();
            ctx.fill();

            ctx.fillStyle = textColor; 
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            ctx.fillText(note, centerX, centerY);
        }
    }


}

//////////////////////////////////////////////////////////////////////////////
// TAB page general handling

function tabSetup() {
    tabShow(URLSearchParamGet("tab_selected", "tab-tones"));

    tabButtons = document.getElementsByClassName("tab-button");
    for (var i = 0; i < tabButtons.length ; i++) {
        tabButton = tabButtons[i];
        tabButton.setAttribute("onclick", "tabShow(\"" + tabButton.id + "\")");
    }
}

function tabShow(tabId) {
    // Show the correct tab
    tabPages = document.getElementsByClassName("tab-page");
    for (var i = 0 ; i < tabPages.length ; i++) {
        tabPage = tabPages[i];
        if(tabPage.id == tabId + "-page")
            tabPage.style.display = "block";
        else
            tabPage.style.display = "none";
    }

    // Mark the active button
    tabButtons = document.getElementsByClassName("tab-button");
    for (var i = 0; i < tabButtons.length ; i++) {
        tabButton = tabButtons[i];
        if (tabButton.id == tabId)
            tabButton.className += " active";
        else 
            tabButton.className = tabButton.className.replace(" active", "");
    }

    // Remember the selected tab
    URLSearchParamSet("tab_selected", tabId, false);

    // Redraw everything
    updateDisplay();
}

//////////////////////////////////////////////////////////////////////////////
// URL search parameters

// Get value of URL search parameter, or default value if it don't exist
function URLSearchParamGet(key, defaultValue) {
    const params = new URLSearchParams(window.location.search);

    if (params.has(key)) {
        return params.get(key);
    }
    return defaultValue;
}

// Set value of URL search parameter. Optionally reload page
function URLSearchParamSet(key, value, reloadPage) {
    const params = new URLSearchParams(window.location.search);
    params.set(key, value);
    if (reloadPage) {
        // Will reload page and replace history
        window.location.search = params.toString(); 
    } else {
        // Just replace history
        history.replaceState({},value,"?" + params.toString());        
    }
}


</script>
<body>

    <div class="tab">
        <button class="tab-button" id="tab-tones">TONES</button>
        <button class="tab-button" id="tab-chords">CHORDS</button>
        <button class="tab-button" id="tab-settings">&#9881;</button>
    </div>

    <!----------------------------------------------------------------------------------->
    <!-- Tones TAB -->
    <div class="tab-page" id="tab-tones-page">
        <canvas id="guitar-canvas"></canvas>
    </div>

    <!----------------------------------------------------------------------------------->
    <!-- Chords TAB -->
    <div class="tab-page" id="tab-chords-page">
    </div>

    <!----------------------------------------------------------------------------------->
    <!-- Settings TAB -->
    <div class="tab-page" id="tab-settings-page">
    </div>

</body>
</html>